<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Product CRUD - Pure Harvest</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
.sidebar-transition { transition: transform 0.3s ease-in-out; }
.product-card { transition: all 0.3s ease; }
.product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.notification { position: fixed; top: 80px; right: 20px; z-index: 100; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
.category-btn { transition: all 0.2s ease; }
.category-btn:hover { transform: scale(1.05); }
.category-btn.active { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.hero-gradient { background: linear-gradient(135deg, #285dad 0%, #273956 100%); }
.qr-btn { transition: all 0.2s ease; }
.qr-btn:hover { transform: scale(1.1); }
.modal-backdrop { backdrop-filter: blur(5px); }
.qr-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
.qr-detail-row:last-child { border-bottom: none; }
.qr-detail-label { font-weight: 600; color: #4b5563; }
.qr-detail-value { color: #1f2937; }
.qr-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px; }
.qr-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
.qr-tab.active { border-bottom-color: #10b981; color: #10b981; font-weight: 600; }
.qr-tab-content { display: none; }
.qr-tab-content.active { display: block; }
.new-product-badge { 
  position: absolute; 
  top: -5px; 
  right: -5px; 
  background: #ef4444; 
  color: white; 
  border-radius: 50%; 
  width: 20px; 
  height: 20px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-size: 10px; 
  font-weight: bold; 
}
</style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">


<nav class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-[60] shadow-sm">
  <div class="flex items-center gap-4">
    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition text-gray-700">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    <div class="text-green-700 font-bold text-2xl flex items-center gap-2 italic">ðŸŒ± Pure Harvest</div>
  </div>
  <div class="hidden md:flex items-center gap-3 mr-4">
    <div class="relative">
      <input type="text" id="searchInput" placeholder="Search products..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 w-64">
      <i data-lucide="search" class="w-5 h-5 absolute left-3 top-2.5 text-gray-400"></i>
    </div>
    <select id="categoryFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
      <option value="">All Categories</option>
    </select>
    <a href="cart.html" class="bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition flex items-center gap-2">
      <i data-lucide="shopping-cart" class="w-5 h-5"></i> Cart
      <span id="cartCount" class="bg-white text-green-700 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">0</span>
    </a>
  </div>
</nav>


<div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-[70] hidden backdrop-blur-sm"></div>
<aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white z-[80] shadow-2xl sidebar-transition -translate-x-full flex flex-col p-6">
  <div class="flex items-center justify-between mb-8">
      <span class="text-green-700 font-bold text-xl">Navigation</span>
      <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
  </div>
  <nav class="flex flex-col gap-2">
    <a href="index.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="home" class="w-5 h-5"></i> Home</a>
    <a href="product-crud.html" class="flex items-center gap-4 p-3 rounded-xl bg-green-700 text-white shadow-lg"><i data-lucide="box" class="w-5 h-5"></i> Product CRUD</a>
    <a href="cart.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="shopping-cart" class="w-5 h-5"></i> Shopping Cart</a>
    <a href="checkout.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="credit-card" class="w-5 h-5"></i> Checkout</a>
    <a href="orders.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="history" class="w-5 h-5"></i> Order History</a>
    <a href="farmer-profile.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="tractor" class="w-5 h-5"></i> Farmer Profile</a>
    <a href="admin.html" class="flex items-center gap-4 p-3 rounded-xl text-gray-600 hover:bg-green-50 transition"><i data-lucide="shield-check" class="w-5 h-5"></i> Admin Panel</a>
  </nav>
</aside>


<div id="notificationContainer"></div>

<main class="flex-1 p-6 md:p-12">
  <div class="max-w-7xl mx-auto">

    <div class="hero-gradient rounded-2xl p-8 mb-8 text-white">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold mb-2">Product Management</h1>
          <p class="text-white/80">Manage your organic products with ease</p>
        </div>
        <div class="flex gap-3 mt-4 md:mt-0">
          <button id="showNewProductsBtn" onclick="toggleNewProducts()" class="bg-amber-500 text-white px-6 py-3 rounded-lg hover:bg-amber-600 transition flex items-center gap-2 font-medium relative">
            <i data-lucide="package" class="w-5 h-5" ></i><a href="new_product.html">Show New Products</a> 
            <span id="newProductsBadge" class="new-product-badge hidden">0</span>
          </button>
          <button onclick="toggleAddForm()" class="bg-white text-green-700 px-6 py-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-2 font-medium">
            <i data-lucide="plus" class="w-5 h-5"></i> Add New Product
          </button>
        </div>
      </div>
    </div>
    

    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Browse by Category</h2>
      <div id="categoryButtons" class="flex flex-wrap gap-3"></div>
    </div>
    

    <div id="addProductForm" class="bg-white p-6 rounded-2xl shadow-md mb-8 hidden fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Add New Product</h2>
        <button onclick="toggleAddForm()" class="p-1 hover:bg-gray-100 rounded">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="productForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
          <input type="text" id="name" placeholder="Product Name" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="category" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="">Select Category</option>
            <option value="Fruits">Fruits</option>
            <option value="Vegetables">Vegetables</option>
            <option value="Dairy">Dairy</option>
            <option value="Meat">Meat</option>
            <option value="Seafood">Seafood</option>
            <option value="Bakery">Bakery</option>
            <option value="Grains">Grains</option>
            <option value="Pantry">Pantry</option>
            <option value="Snacks">Snacks</option>
            <option value="Beverages">Beverages</option>
            <option value="Frozen Foods">Frozen Foods</option>
            <option value="Condiments">Condiments</option>
            <option value="Herbs">Herbs</option>
            <option value="Baby Food">Baby Food</option>
            <option value="Pet Food">Pet Food</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
          <input type="number" id="price" placeholder="Price" step="0.01" min="0" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
          <input type="number" id="stock" placeholder="Stock" min="0" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
          <input type="text" id="image" placeholder="Image URL" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Production Date</label>
          <input type="date" id="productionDate" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
          <input type="date" id="expiryDate" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div class="flex items-end">
          <button type="submit" class="bg-green-700 text-white py-2 px-4 rounded-lg hover:bg-green-800 transition w-full">Add Product</button>
        </div>
      </form>
    </div>

 
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
      <h2 class="text-xl font-semibold text-gray-800">Products</h2>
      <div class="flex items-center gap-2 mt-2 md:mt-0">
        <span class="text-sm text-gray-600">Showing</span>
        <span id="showingCount" class="text-sm font-medium">0</span>
        <span class="text-sm text-gray-600">of</span>
        <span id="totalCount" class="text-sm font-medium">0</span>
        <span class="text-sm text-gray-600">products</span>
      </div>
    </div>
    

    <div id="productContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    

    <div id="emptyState" class="bg-white p-8 rounded-xl shadow text-center hidden">
      <i data-lucide="package" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
      <h2 class="text-xl font-semibold text-gray-700 mb-2">No products found</h2>
      <p class="text-gray-500 mb-4">Try adjusting your search or filter criteria</p>
      <button onclick="resetFilters()" class="bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition">
        Reset Filters
      </button>
    </div>
    

    <div class="flex justify-center mt-8">
      <nav class="flex items-center gap-2">
        <button onclick="previousPage()" class="p-2 rounded-lg bg-white hover:bg-gray-100 transition">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <div id="pageNumbers" class="flex gap-2"></div>
        <button onclick="nextPage()" class="p-2 rounded-lg bg-white hover:bg-gray-100 transition">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </nav>
    </div>
  </div>
</main>


<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-xl p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Edit Product</h2>
      <button onclick="closeEditModal()" class="p-1 hover:bg-gray-100 rounded">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <form id="editForm" class="space-y-4">
      <input type="hidden" id="editId">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
        <input type="text" id="editName" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select id="editCategory" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
          <option value="Fruits">Fruits</option>
          <option value="Vegetables">Vegetables</option>
          <option value="Dairy">Dairy</option>
          <option value="Meat">Meat</option>
          <option value="Seafood">Seafood</option>
          <option value="Bakery">Bakery</option>
          <option value="Grains">Grains</option>
          <option value="Pantry">Pantry</option>
          <option value="Snacks">Snacks</option>
          <option value="Beverages">Beverages</option>
          <option value="Frozen Foods">Frozen Foods</option>
          <option value="Condiments">Condiments</option>
          <option value="Herbs">Herbs</option>
          <option value="Baby Food">Baby Food</option>
          <option value="Pet Food">Pet Food</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
        <input type="number" id="editPrice" step="0.01" min="0" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
        <input type="number" id="editStock" min="0" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
        <input type="text" id="editImage" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Production Date</label>
        <input type="date" id="editProductionDate" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
        <input type="date" id="editExpiryDate" class="p-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-green-500">
      </div>
      <div class="flex gap-2">
        <button type="submit" class="bg-green-700 text-white py-2 px-4 rounded-lg hover:bg-green-800 transition flex-1">Save Changes</button>
        <button type="button" onclick="closeEditModal()" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition flex-1">Cancel</button>
      </div>
    </form>
  </div>
</div>


<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Product QR Code</h2>
      <button onclick="closeQRModal()" class="p-1 hover:bg-gray-100 rounded">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <div class="flex flex-col md:flex-row gap-6">
      <div class="flex flex-col items-center">
        <div id="qrcode" class="mb-4"></div>
        <button onclick="downloadQR()" class="bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition flex items-center gap-2">
          <i data-lucide="download" class="w-4 h-4"></i> Download
        </button>
      </div>
      
      <div class="flex-1">
        <h3 id="qrProductName" class="text-lg font-semibold text-gray-800 mb-2"></h3>
        

        <div class="qr-tabs">
          <div class="qr-tab active" onclick="switchTab('basic')">Basic Info</div>
          <div class="qr-tab" onclick="switchTab('dates')">Dates</div>
          <div class="qr-tab" onclick="switchTab('all')">All Details</div>
        </div>
        

        <div id="basic-tab" class="qr-tab-content active">
          <div class="space-y-2">
            <div class="qr-detail-row">
              <span class="qr-detail-label">Category:</span>
              <span id="qrProductCategory" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Price:</span>
              <span id="qrProductPrice" class="qr-detail-value text-green-700 font-semibold"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Stock:</span>
              <span id="qrProductStock" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Product ID:</span>
              <span id="qrProductId" class="qr-detail-value"></span>
            </div>
          </div>
        </div>
        

        <div id="dates-tab" class="qr-tab-content">
          <div class="space-y-2">
            <div class="qr-detail-row">
              <span class="qr-detail-label">Production Date:</span>
              <span id="qrProductionDate" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Expiry Date:</span>
              <span id="qrExpiryDate" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Days Until Expiry:</span>
              <span id="qrDaysUntilExpiry" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Freshness Status:</span>
              <span id="qrFreshnessStatus" class="qr-detail-value"></span>
            </div>
          </div>
        </div>
        

        <div id="all-tab" class="qr-tab-content">
          <div class="space-y-2">
            <div class="qr-detail-row">
              <span class="qr-detail-label">Product ID:</span>
              <span id="qrAllId" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Name:</span>
              <span id="qrAllName" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Category:</span>
              <span id="qrAllCategory" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Price:</span>
              <span id="qrAllPrice" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Stock:</span>
              <span id="qrAllStock" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Production Date:</span>
              <span id="qrAllProductionDate" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Expiry Date:</span>
              <span id="qrAllExpiryDate" class="qr-detail-value"></span>
            </div>
            <div class="qr-detail-row">
              <span class="qr-detail-label">Image URL:</span>
              <span id="qrAllImage" class="qr-detail-value text-xs break-all"></span>
            </div>
          </div>
        </div>
        
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <p class="text-sm text-blue-800">Scan this QR code with your smartphone to view complete product details instantly.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

let products = [];
let filteredProducts = [];
let currentPage = 1;
const productsPerPage = 12;
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let activeCategory = '';
let currentQRProduct = null;
let qrcode = null;
let newProducts = [];
let showingNewProducts = false;
let lastProductCheck = new Date().toISOString();


const categoryStyles = {
  'Fruits': { bg: 'bg-red-100', text: 'text-red-700', icon: 'apple' },
  'Vegetables': { bg: 'bg-green-100', text: 'text-green-700', icon: 'carrot' },
  'Dairy': { bg: 'bg-blue-100', text: 'text-blue-700', icon: 'milk' },
  'Meat': { bg: 'bg-orange-100', text: 'text-orange-700', icon: 'beef' },
  'Seafood': { bg: 'bg-cyan-100', text: 'text-cyan-700', icon: 'fish' },
  'Bakery': { bg: 'bg-amber-100', text: 'text-amber-700', icon: 'wheat' },
  'Grains': { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'grain' },
  'Pantry': { bg: 'bg-purple-100', text: 'text-purple-700', icon: 'jar' },
  'Snacks': { bg: 'bg-pink-100', text: 'text-pink-700', icon: 'cookie' },
  'Beverages': { bg: 'bg-indigo-100', text: 'text-indigo-700', icon: 'coffee' },
  'Frozen Foods': { bg: 'bg-sky-100', text: 'text-black', icon: 'snowflake' },
  'Condiments': { bg: 'bg-rose-100', text: 'text-black', icon: 'sauce' },
  'Herbs': { bg: 'bg-lime-100', text: 'text-black', icon: 'leaf' },
  'Baby Food': { bg: 'bg-pink-100', text: 'text-black', icon: 'baby' },
  'Pet Food': { bg: 'bg-amber-100', text: 'text-black', icon: 'dog' }
};


async function loadProducts() {
  try {

    const res = await fetch('http://localhost:3000/api/products');
    if (res.ok) {
      const fetchedProducts = await res.json();
      

      if (products.length > 0) {
        const previousProductIds = products.map(p => p.id);
        newProducts = fetchedProducts.filter(product => 
          !previousProductIds.includes(product.id)
        );
        updateNewProductsBadge();
      }
      
      products = fetchedProducts;
    } else {

      const fallbackRes = await fetch('product.json');
      products = await fallbackRes.json();
    }
    

    if (!showingNewProducts) {
      filteredProducts = [...products];
    }
    
    renderProducts();
    populateCategories();
    updateCartCount();
    updateProductCount();
  } catch (error) {
    console.error("Error loading products:", error);
   
    try {
      const fallbackRes = await fetch('product.json');
      products = await fallbackRes.json();
      
     
      if (!showingNewProducts) {
        filteredProducts = [...products];
      }
      
      renderProducts();
      populateCategories();
      updateCartCount();
      updateProductCount();
    } catch (fallbackError) {
      console.error("Error loading fallback products:", fallbackError);
      showNotification("Failed to load products!", "error");
    }
  }
}


function updateNewProductsBadge() {
  const badge = document.getElementById('newProductsBadge');
  if (newProducts.length > 0) {
    badge.textContent = newProducts.length;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}


function toggleNewProducts() {
  showingNewProducts = !showingNewProducts;
  
  if (showingNewProducts) {

    filteredProducts = [...newProducts];
    document.getElementById('showNewProductsBtn').classList.add('bg-amber-600');
    document.getElementById('showNewProductsBtn').classList.remove('bg-amber-500');
    showNotification(`Showing ${newProducts.length} new products`);
  } else {
 
    filteredProducts = [...products];
    document.getElementById('showNewProductsBtn').classList.remove('bg-amber-600');
    document.getElementById('showNewProductsBtn').classList.add('bg-amber-500');
    showNotification("Showing all products");
  }
  

  document.getElementById('searchInput').value = '';
  document.getElementById('categoryFilter').value = '';
  activeCategory = '';
  
  currentPage = 1;
  renderProducts();
  updateProductCount();
}


function populateCategories() {
  const categories = [...new Set(products.map(p => p.category))];
  const categoryFilter = document.getElementById('categoryFilter');
  const categoryButtons = document.getElementById('categoryButtons');
  

  categoryFilter.innerHTML = '<option value="">All Categories</option>';
  categoryButtons.innerHTML = '';
  

  const allButton = createCategoryButton('All Categories', '', true);
  categoryButtons.appendChild(allButton);
  
  
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    categoryFilter.appendChild(option);
    
    const button = createCategoryButton(category, category);
    categoryButtons.appendChild(button);
  });
  
  categoryFilter.addEventListener('change', filterProducts);
}


function createCategoryButton(name, value, isActive = false) {
  const button = document.createElement('button');
  button.className = `category-btn px-4 py-2 rounded-full flex items-center gap-2 ${
    isActive ? 'bg-green-700 text-white active' : 'bg-white text-gray-700 border border-gray-300'
  }`;
  
  if (value && categoryStyles[value]) {
    const style = categoryStyles[value];
    if (!isActive) {
      button.className = `category-btn px-4 py-2 rounded-full flex items-center gap-2 ${style.bg} ${style.text}`;
    }
  }
  
  button.innerHTML = `
    ${value && categoryStyles[value] ? `<i data-lucide="${categoryStyles[value].icon}" class="w-4 h-4"></i>` : ''}
    <span>${name}</span>
  `;
  
  button.onclick = () => filterByCategory(value);
  return button;
}


function filterByCategory(category) {
  activeCategory = category;
  document.getElementById('categoryFilter').value = category;
  
  
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(button => {
    button.classList.remove('bg-green-700', 'text-white', 'active');
    
    if (button.textContent.includes(category) || (category === '' && button.textContent.includes('All'))) {
      button.classList.add('bg-green-700', 'text-white', 'active');
    } else {
      const buttonText = button.textContent.trim();
      if (categoryStyles[buttonText]) {
        const style = categoryStyles[buttonText];
        button.className = `category-btn px-4 py-2 rounded-full flex items-center gap-2 ${style.bg} ${style.text}`;
      } else {
        button.className = 'category-btn px-4 py-2 rounded-full flex items-center gap-2 bg-white text-gray-700 border border-gray-300';
      }
    }
  });
  
  filterProducts();
}


function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('categoryFilter').value = '';
  filterByCategory('');
}


function filterProducts() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const category = document.getElementById('categoryFilter').value;
  
  let sourceProducts = showingNewProducts ? newProducts : products;
  
  filteredProducts = sourceProducts.filter(product => {
    const matchesSearch = product.name.toLowerCase().includes(searchTerm);
    const matchesCategory = !category || product.category === category;
    return matchesSearch && matchesCategory;
  });
  
  currentPage = 1;
  renderProducts();
  updateProductCount();
}


document.getElementById('searchInput').addEventListener('input', filterProducts);


function updateProductCount() {
  const startIndex = (currentPage - 1) * productsPerPage;
  const endIndex = Math.min(startIndex + productsPerPage, filteredProducts.length);
  
  document.getElementById('showingCount').textContent = 
    filteredProducts.length > 0 ? `${startIndex + 1}-${endIndex}` : '0';
  document.getElementById('totalCount').textContent = filteredProducts.length;
}


function renderProducts() {
  const container = document.getElementById('productContainer');
  const emptyState = document.getElementById('emptyState');
  
  container.innerHTML = '';
  
  if (filteredProducts.length === 0) {
    container.classList.add('hidden');
    emptyState.classList.remove('hidden');
    renderPagination();
    lucide.createIcons();
    return;
  }
  
  container.classList.remove('hidden');
  emptyState.classList.add('hidden');
  
  const startIndex = (currentPage - 1) * productsPerPage;
  const endIndex = startIndex + productsPerPage;
  const paginatedProducts = filteredProducts.slice(startIndex, endIndex);
  
  paginatedProducts.forEach(p => {
    const card = document.createElement('div');
    card.className = "bg-white rounded-xl shadow-md overflow-hidden product-card fade-in";
    
    const stockStatus = p.stock > 10 ? 'text-green-600' : p.stock > 0 ? 'text-yellow-600' : 'text-red-600';
    const stockText = p.stock > 10 ? 'In Stock' : p.stock > 0 ? `Low Stock (${p.stock})` : 'Out of Stock';
    

    const categoryStyle = categoryStyles[p.category] || { bg: 'bg-gray-100', text: 'text-gray-700' };
    
   
    const prodDate = p.productionDate ? new Date(p.productionDate).toLocaleDateString() : 'N/A';
    const expDate = p.expiryDate ? new Date(p.expiryDate).toLocaleDateString() : 'N/A';
    
 
    const isNew = newProducts.some(np => np.id === p.id);
    
    card.innerHTML = `
      <div class="relative">
        <img src="${p.image}" alt="${p.name}" class="w-full h-48 object-cover">
        <span class="absolute top-3 right-3 bg-white px-2 py-1 rounded-full text-xs font-semibold ${stockStatus}">
          ${stockText}
        </span>
        <div class="absolute top-3 left-3 ${categoryStyle.bg} ${categoryStyle.text} px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
          ${categoryStyle.icon ? `<i data-lucide="${categoryStyle.icon}" class="w-3 h-3"></i>` : ''}
          ${p.category}
        </div>
        ${isNew ? '<div class="absolute top-3 right-20 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium">NEW</div>' : ''}
        <button onclick="showQRCode(${p.id})" class="absolute bottom-3 right-3 qr-btn bg-white p-2 rounded-full shadow-md">
          <i data-lucide="qr-code" class="w-5 h-5 text-gray-700"></i>
        </button>
      </div>
      <div class="p-4">
        <h3 class="font-bold text-lg text-gray-800 mb-1">${p.name}</h3>
        <div class="flex justify-between items-center mb-3">
          <p class="text-green-700 font-bold text-lg">$${p.price.toFixed(2)}</p>
          <p class="text-gray-500 text-sm">Stock: ${p.stock}</p>
        </div>
        <div class="text-xs text-gray-500 mb-3">
          <div>Prod: ${prodDate}</div>
          <div>Exp: ${expDate}</div>
        </div>
        <div class="flex gap-2">
          <button onclick="editProduct(${p.id})" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-1">
            <i data-lucide="edit-2" class="w-4 h-4"></i> Edit
          </button>
          <button onclick="deleteProduct(${p.id})" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-1">
            <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
          </button>
        </div>
        <button onclick="buyProduct(${p.id})" class="w-full mt-2 bg-green-700 text-white py-2 rounded-lg hover:bg-green-800 transition flex items-center justify-center gap-1">
          <i data-lucide="shopping-cart" class="w-4 h-4"></i> Add to Cart
        </button>
      </div>
    `;
    container.appendChild(card);
  });
  
  renderPagination();
  updateProductCount();
  lucide.createIcons();
}


function renderPagination() {
  const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
  const pageNumbers = document.getElementById('pageNumbers');
  pageNumbers.innerHTML = '';
  
  
  if (totalPages <= 1) return;
  

  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  
 
  if (endPage - startPage < 4) {
    startPage = Math.max(1, endPage - 4);
  }
  

  if (startPage > 1) {
    const firstButton = createPageButton(1);
    pageNumbers.appendChild(firstButton);
    
    if (startPage > 2) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      ellipsis.className = 'px-2';
      pageNumbers.appendChild(ellipsis);
    }
  }
  
 
  for (let i = startPage; i <= endPage; i++) {
    const button = createPageButton(i);
    pageNumbers.appendChild(button);
  }
  
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const ellipsis = document.createElement('span');
      ellipsis.textContent = '...';
      ellipsis.className = 'px-2';
      pageNumbers.appendChild(ellipsis);
    }
    
    const lastButton = createPageButton(totalPages);
    pageNumbers.appendChild(lastButton);
  }
}


function createPageButton(pageNum) {
  const button = document.createElement('button');
  button.textContent = pageNum;
  button.className = `p-2 rounded-lg ${
    pageNum === currentPage ? 'bg-green-700 text-white' : 'bg-white hover:bg-gray-100'
  }`;
  button.onclick = () => goToPage(pageNum);
  return button;
}

function goToPage(page) {
  currentPage = page;
  renderProducts();
}

function previousPage() {
  if (currentPage > 1) {
    currentPage--;
    renderProducts();
  }
}

function nextPage() {
  const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderProducts();
  }
}

function toggleAddForm() {
  const form = document.getElementById('addProductForm');
  form.classList.toggle('hidden');
}


function switchTab(tabName) {
  
  const tabs = document.querySelectorAll('.qr-tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
    if (tab.textContent.toLowerCase().includes(tabName) || 
        (tabName === 'basic' && tab.textContent.includes('Basic')) ||
        (tabName === 'dates' && tab.textContent.includes('Dates')) ||
        (tabName === 'all' && tab.textContent.includes('All'))) {
      tab.classList.add('active');
    }
  });
  

  const tabContents = document.querySelectorAll('.qr-tab-content');
  tabContents.forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`${tabName}-tab`).classList.add('active');
}


function showQRCode(id) {
  const product = products.find(p => p.id === id);
  if (!product) return;
  
  currentQRProduct = product;
  
 
  document.getElementById('qrProductName').textContent = product.name;
  document.getElementById('qrProductCategory').textContent = product.category;
  document.getElementById('qrProductPrice').textContent = `$${product.price.toFixed(2)}`;
  document.getElementById('qrProductStock').textContent = product.stock;
  document.getElementById('qrProductId').textContent = product.id;
  
  const prodDate = product.productionDate ? new Date(product.productionDate).toLocaleDateString() : 'N/A';
  const expDate = product.expiryDate ? new Date(product.expiryDate).toLocaleDateString() : 'N/A';
  
  document.getElementById('qrProductionDate').textContent = prodDate;
  document.getElementById('qrExpiryDate').textContent = expDate;
  
 
  if (product.expiryDate) {
    const today = new Date();
    const expiry = new Date(product.expiryDate);
    const diffTime = expiry - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    document.getElementById('qrDaysUntilExpiry').textContent = diffDays > 0 ? `${diffDays} days` : 'Expired';
    
  
    let status = '';
    let statusClass = '';
    
    if (diffDays < 0) {
      status = 'Expired';
      statusClass = 'text-red-600 font-semibold';
    } else if (diffDays <= 7) {
      status = 'Expiring Soon';
      statusClass = 'text-orange-600 font-semibold';
    } else if (diffDays <= 30) {
      status = 'Fresh';
      statusClass = 'text-green-600 font-semibold';
    } else {
      status = 'Very Fresh';
      statusClass = 'text-green-700 font-semibold';
    }
    
    const statusElement = document.getElementById('qrFreshnessStatus');
    statusElement.textContent = status;
    statusElement.className = `qr-detail-value ${statusClass}`;
  } else {
    document.getElementById('qrDaysUntilExpiry').textContent = 'N/A';
    document.getElementById('qrFreshnessStatus').textContent = 'N/A';
  }
  

  document.getElementById('qrAllId').textContent = product.id;
  document.getElementById('qrAllName').textContent = product.name;
  document.getElementById('qrAllCategory').textContent = product.category;
  document.getElementById('qrAllPrice').textContent = `$${product.price.toFixed(2)}`;
  document.getElementById('qrAllStock').textContent = product.stock;
  document.getElementById('qrAllProductionDate').textContent = prodDate;
  document.getElementById('qrAllExpiryDate').textContent = expDate;
  document.getElementById('qrAllImage').textContent = product.image;
  

  document.getElementById('qrcode').innerHTML = '';
  

  const qrData = {
    id: product.id,
    name: product.name,
    category: product.category,
    price: product.price,
    stock: product.stock,
    productionDate: product.productionDate,
    expiryDate: product.expiryDate,
    image: product.image
  };
  
  qrcode = new QRCode(document.getElementById('qrcode'), {
    text: JSON.stringify(qrData),
    width: 200,
    height: 200,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  

  switchTab('basic');
  

  document.getElementById('qrModal').classList.remove('hidden');
}


function closeQRModal() {
  document.getElementById('qrModal').classList.add('hidden');
  currentQRProduct = null;
  qrcode = null;
}


function downloadQR() {
  if (!currentQRProduct || !qrcode) return;
  

  const canvas = document.querySelector('#qrcode canvas');
  if (!canvas) return;
  

  canvas.toBlob(function(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentQRProduct.name.replace(/\s+/g, '_')}_QR.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification("QR code downloaded successfully!");
  });
}


function showNotification(message, type = 'success') {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = `notification p-4 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-500' : 'bg-red-500'
  } text-white`;
  notification.innerHTML = `
    <div class="flex items-center gap-2">
      <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
      <span>${message}</span>
    </div>
  `;
  container.appendChild(notification);
  lucide.createIcons();
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}


function updateCartCount() {
  const cartCount = document.getElementById('cartCount');
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  cartCount.textContent = totalItems;
}


function buyProduct(id) {
  const product = products.find(p => p.id === id);
  if (product.stock <= 0) {
    showNotification("Product is out of stock!", "error");
    return;
  }
  
  const existing = cart.find(item => item.id === id);
  
  if(existing){
    if (existing.quantity >= product.stock) {
      showNotification("Not enough stock available!", "error");
      return;
    }
    existing.quantity += 1;
  } else {
    cart.push({...product, quantity: 1});
  }
  
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  showNotification("Product added to cart!");
}


document.getElementById('productForm').addEventListener('submit', function(e){
  e.preventDefault();
  const id = Date.now();
  const name = document.getElementById('name').value;
  const category = document.getElementById('category').value;
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value);
  const image = document.getElementById('image').value;
  const productionDate = document.getElementById('productionDate').value;
  const expiryDate = document.getElementById('expiryDate').value;
  
  if(name && category && !isNaN(price) && !isNaN(stock) && image) {
  
    fetch('http://localhost:3000/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name, category, price, stock, image, productionDate, expiryDate
      })
    })
    .then(res => res.json())
    .then(data => {
   
      loadProducts();
      this.reset();
      toggleAddForm();
      showNotification("Product added successfully!");
    })
    .catch(error => {
      console.error('Error adding product:', error);
      showNotification("Server error! Product not saved to database.", "error");
    });
  } else {
    showNotification("Fill all fields correctly!", "error");
  }
});


function editProduct(id) {
  const p = products.find(p => p.id === id);
  document.getElementById('editId').value = p.id;
  document.getElementById('editName').value = p.name;
  document.getElementById('editCategory').value = p.category;
  document.getElementById('editPrice').value = p.price;
  document.getElementById('editStock').value = p.stock;
  document.getElementById('editImage').value = p.image;
  document.getElementById('editProductionDate').value = p.productionDate || '';
  document.getElementById('editExpiryDate').value = p.expiryDate || '';
  document.getElementById('editModal').classList.remove('hidden');
}


function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}


document.getElementById('editForm').addEventListener('submit', function(e){
  e.preventDefault();
  const id = parseInt(document.getElementById('editId').value);
  const name = document.getElementById('editName').value;
  const category = document.getElementById('editCategory').value;
  const price = parseFloat(document.getElementById('editPrice').value);
  const stock = parseInt(document.getElementById('editStock').value);
  const image = document.getElementById('editImage').value;
  const productionDate = document.getElementById('editProductionDate').value;
  const expiryDate = document.getElementById('editExpiryDate').value;
  

  fetch(`http://localhost:3000/api/products/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name, category, price, stock, image, productionDate, expiryDate
    })
  })
  .then(res => res.json())
  .then(data => {
   
    loadProducts();
    closeEditModal();
    showNotification("Product updated successfully!");
  })
  .catch(error => {
    console.error('Error updating product:', error);
    showNotification("Server error! Product not updated.", "error");
  });
});


function deleteProduct(id) {
  if(confirm("Are you sure you want to delete this product?")) {
    
    fetch(`http://localhost:3000/api/products/${id}`, {
      method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
      
      loadProducts();
      showNotification("Product deleted successfully!");
    })
    .catch(error => {
      console.error('Error deleting product:', error);
      showNotification("Server error! Product not deleted.", "error");
    });
  }
}


function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');

  if(sidebar.classList.contains('-translate-x-full')){
    sidebar.classList.remove('-translate-x-full');
    overlay.classList.remove('hidden');
  } else {
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('hidden');
  }
}


document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);


setInterval(() => {
  loadProducts();
}, 30000); 


loadProducts();


document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
});
</script>
</body>
</html>